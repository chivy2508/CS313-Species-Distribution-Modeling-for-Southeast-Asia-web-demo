<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Habitat Suitability Prediction</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:Inter,Arial,sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
  height:100vh;overflow:hidden
}
header{
  background:#fff;padding:14px 24px;
  box-shadow:0 4px 20px rgba(0,0,0,.1)
}
h1{
  margin:0;font-size:22px;font-weight:700;
  background:linear-gradient(135deg,#667eea,#764ba2);
  background-clip:text;
  -webkit-background-clip:text;-webkit-text-fill-color:transparent
}
.controls{
  background:#fff;padding:10px 24px;
  display:flex;gap:12px;align-items:center;
  flex-wrap:wrap
}
input[type=file]{display:none}
label{
  border:2px solid #e5e7eb;
  padding:6px 14px;border-radius:8px;cursor:pointer;
  transition:all .3s ease
}
label:hover{border-color:#667eea;color:#667eea}

button{
  padding:6px 18px;border-radius:8px;
  border:none;font-weight:600;cursor:pointer;
  transition:all .3s ease
}
.primary{background:#667eea;color:#fff}
.primary:hover{background:#5568d3;transform:translateY(-1px)}
.secondary{background:#fff;border:2px solid #e5e7eb;color:#374151}
.secondary:hover{border-color:#667eea;color:#667eea}

select{
  padding:6px 12px;border-radius:8px;
  border:2px solid #e5e7eb;font-weight:500;
  cursor:pointer;background:#fff
}
select:focus{outline:none;border-color:#667eea}

.control-group{
  display:flex;align-items:center;gap:8px;
  padding:4px 12px;border-radius:8px;
  background:#f9fafb
}
.control-group label{
  border:none;padding:0;
  font-size:13px;font-weight:500;color:#6b7280
}
.stats{margin-left:auto;font-size:13px;font-weight:500}

.main{
  display:flex;height:calc(100vh - 110px);
  gap:14px;padding:14px
}
#map{flex:3;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.12)}

.panel{
  flex:1;background:#fff;border-radius:16px;
  padding:16px;overflow-y:auto;
  box-shadow:0 8px 30px rgba(0,0,0,.12)
}
.panel h3{
  margin:0 0 12px;color:#4f46e5;font-size:15px;
  font-weight:700;border-bottom:2px solid #f3f4f6;
  padding-bottom:8px
}
ul{padding-left:18px;font-size:13px;margin:8px 0}
li{margin:4px 0;color:#374151}

canvas{width:100%!important;height:150px!important;margin-bottom:12px}

.info-box{
  background:#eef2ff;padding:12px;
  border-radius:10px;font-size:13px;
  margin-top:12px;border-left:4px solid #667eea
}
.info-box b{color:#4338ca}

.feature-grid{
  display:flex;gap:12px;margin-top:8px
}
.feature-box{
  flex:1;background:#f9fafb;
  border-radius:10px;padding:12px;
  border:1px solid #e5e7eb
}
.feature-box h4{
  margin:0 0 8px;font-size:14px;color:#4338ca;
  font-weight:600
}

/* Statistics Panel */
.stats-panel{
  background:linear-gradient(135deg,#667eea15,#764ba215);
  border-radius:12px;padding:14px;
  margin-top:12px;border:2px solid #e0e7ff
}
.stats-grid{
  display:grid;grid-template-columns:1fr 1fr;
  gap:10px;margin-top:8px
}
.stat-item{
  background:#fff;padding:10px;border-radius:8px;
  box-shadow:0 2px 8px rgba(0,0,0,.05)
}
.stat-label{
  font-size:11px;color:#6b7280;
  text-transform:uppercase;font-weight:600
}
.stat-value{
  font-size:20px;font-weight:700;
  color:#4338ca;margin-top:4px
}
.stat-subtext{
  font-size:11px;color:#9ca3af;margin-top:2px
}

/* View Toggle */
.view-toggle{
  display:none
}

/* Model Badge */
.model-badge{
  display:inline-block;
  background:#fff;
  color:#667eea;padding:4px 12px;
  border-radius:6px;font-size:12px;
  font-weight:700;margin-left:8px;
  border:2px solid #667eea;
  box-shadow:0 2px 8px rgba(102,126,234,.2)
}
</style>
</head>

<body>

<header>
  <h1>Habitat Suitability Prediction</h1>
</header>

<div class="controls">
  <label for="csvFile">
     Ch·ªçn file CSV
  </label>
  <input type="file" id="csvFile" accept=".csv">
  
  <button class="primary" onclick="uploadCSV()">üöÄ D·ª± ƒëo√°n</button>
  <button class="secondary" onclick="clearAll()">üóëÔ∏è X√≥a</button>

  <div class="control-group">
    <label> Model:</label>
    <select id="modelSelect" onchange="changeModel()">
     <option value="xgboost">XGBoost</option>
     <option value="randomforest">Random Forest</option>
     <option value="logistic">Logistic Regression</option>
     <option value="lgbm">LightGBM</option>
     <option value="stacking">Stacking Ensemble</option>
    </select>
  </div>

  <div class="control-group">
    <label> Ng∆∞·ª°ng:</label>
    <input type="range" min="0.3" max="0.7" step="0.05"
           value="0.5" id="threshold" style="width:80px">
    <span id="thVal" style="font-weight:700;color:#4338ca">0.50</span>
  </div>

  <div class="stats" id="stats"></div>
</div>

<div class="main">
  <div id="map"></div>

  <div class="panel">
    <h3> Ph√¢n b·ªë x√°c su·∫•t</h3>
    <canvas id="chart"></canvas>

    <h3> Feature Importance</h3>
    <div class="feature-grid">
      <div class="feature-box">
        <h4>Local (SHAP)</h4>
        <ul id="localFeatures">
          <li style="color:#9ca3af">Click v√†o b·∫£n ƒë·ªì ƒë·ªÉ xem</li>
        </ul>
      </div>
      <div class="feature-box">
        <h4>Global</h4>
        <ul id="globalFeatures"></ul>
      </div>
    </div>

    <div class="stats-panel">
      <h3 style="margin:0 0 8px;font-size:14px">üìà Statistics</h3>
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-label">Total Predictions</div>
          <div class="stat-value" id="totalPredictions">0</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Avg Probability</div>
          <div class="stat-value" id="avgProb">0%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Present</div>
          <div class="stat-value" id="presentCount">0</div>
          <div class="stat-subtext" id="presentPercent">0%</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Absent</div>
          <div class="stat-value" id="absentCount">0</div>
          <div class="stat-subtext" id="absentPercent">0%</div>
        </div>
      </div>
    </div>

    <div class="info-box">
      <b> Inference time:</b> <span id="inferTime">-</span> ms
    </div>
  </div>
</div>

<script>
/* MAP */
const map=L.map("map").setView([15,108],5);
L.tileLayer(
 "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
 {maxZoom:19,attribution:'¬© OpenStreetMap ¬© CARTO'}
).addTo(map);

const markers=L.layerGroup().addTo(map);
let heatLayer=null;
let threshold=0.5;
let clickBins=[0,0,0,0,0];
let allPredictions=[];

// Statistics
let stats={
  total:0,
  present:0,
  absent:0,
  sumProb:0
};

document.getElementById("threshold").oninput=e=>{
 threshold=parseFloat(e.target.value);
 document.getElementById("thVal").innerText=threshold.toFixed(2);
};

/* CHART */
const chart=new Chart(document.getElementById("chart"),{
 type:"bar",
 data:{
  labels:["0-0.2","0.2-0.4","0.4-0.6","0.6-0.8","0.8-1"],
  datasets:[{
    data:clickBins,
    backgroundColor:"#667eea",
    borderRadius:6
  }]
 },
 options:{
   plugins:{legend:{display:false}},
   scales:{
     y:{beginAtZero:true,ticks:{precision:0}}
   }
 }
});

/* MODEL SELECTION */
async function changeModel(){
  const modelKey=document.getElementById("modelSelect").value;
  const res=await fetch("/set_model",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({model_key:modelKey})
  });
  const data=await res.json();
  if(data.success){
    document.getElementById("modelBadge").innerText=data.model;
    loadGlobal();
    // Clear predictions khi ƒë·ªïi model
    clearAll();
  }
}

/* GLOBAL FEATURES */
async function loadGlobal(){
 const res=await fetch("/feature_importance");
 const data=await res.json();
 const ul=document.getElementById("globalFeatures");
 ul.innerHTML="";
 data.forEach(f=>{
  ul.innerHTML+=`<li><b>${f.feature}</b>: ${f.importance}</li>`;
 });
}
loadGlobal();

/* UPDATE STATISTICS */
function updateStats(){
  document.getElementById("totalPredictions").innerText=stats.total;
  document.getElementById("presentCount").innerText=stats.present;
  document.getElementById("absentCount").innerText=stats.absent;
  
  const presentPct=stats.total>0?(stats.present/stats.total*100).toFixed(1):0;
  const absentPct=stats.total>0?(stats.absent/stats.total*100).toFixed(1):0;
  const avgProb=stats.total>0?(stats.sumProb/stats.total*100).toFixed(1):0;
  
  document.getElementById("presentPercent").innerText=`${presentPct}%`;
  document.getElementById("absentPercent").innerText=`${absentPct}%`;
  document.getElementById("avgProb").innerText=`${avgProb}%`;
}

/* MAP CLICK */
map.on("click",async e=>{
 const t0=performance.now();
 const res=await fetch("/predict_by_location",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({lat:e.latlng.lat,lon:e.latlng.lng,threshold})
 });
 const d=await res.json();
 document.getElementById("inferTime").innerText=(performance.now()-t0).toFixed(1);

 const p=d.probability;
 
 // Update bins
 if(p<.2)clickBins[0]++;
 else if(p<.4)clickBins[1]++;
 else if(p<.6)clickBins[2]++;
 else if(p<.8)clickBins[3]++;
 else clickBins[4]++;
 chart.update();

 // Update statistics
 stats.total++;
 stats.sumProb+=p;
 if(p>=threshold)stats.present++;
 else stats.absent++;
 updateStats();

 L.circleMarker(e.latlng,{
  radius:8,
  fillColor:p>=threshold?"#ef4444":"#3b82f6",
  fillOpacity:.85,color:"#fff",weight:2
 }).addTo(markers)
 .bindPopup(`
   <div style="padding:4px">
     <b style="font-size:15px">${d.label}</b><br>
     <span style="font-size:13px">X√°c su·∫•t: <b>${(p*100).toFixed(1)}%</b></span><br>
     <span style="font-size:11px;color:#6b7280">üìç ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}</span>
   </div>
 `)
 .openPopup();

 loadLocal(e.latlng.lat,e.latlng.lng);
});

/* LOCAL SHAP */
async function loadLocal(lat,lon){
 const res=await fetch("/local_explain",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({lat,lon})
 });
 const data=await res.json();
 const ul=document.getElementById("localFeatures");
 ul.innerHTML="";
 data.local_features.forEach(f=>{
  const val=f.shap_value;
  const color=val>0?"#ef4444":"#3b82f6";
  ul.innerHTML+=`<li><b>${f.feature}</b>: <span style="color:${color}">${val}</span></li>`;
 });
}

/* RENDER PREDICTIONS */
function renderPredictions(predictions){
  markers.clearLayers();
  if(heatLayer){
    map.removeLayer(heatLayer);
    heatLayer=null;
  }

  // Hi·ªÉn th·ªã markers
  predictions.forEach(d=>{
    const p=d.probability;
    if(p>=threshold){
      L.circleMarker([d.decimalLatitude,d.decimalLongitude],{
        radius:4,
        fillColor:p>=0.7?"#ef4444":p>=0.5?"#f59e0b":"#3b82f6",
        fillOpacity:0.75,
        color:"#fff",
        weight:1
      }).addTo(markers)
      .bindPopup(`<b>${(p*100).toFixed(1)}%</b>`);
    }
  });
}

/* CSV UPLOAD */
async function uploadCSV(){
 const file=document.getElementById("csvFile").files[0];
 if(!file) return alert("Ch∆∞a ch·ªçn file");

 const fd=new FormData(); 
 fd.append("file",file);

 const res=await fetch("/predict_csv",{method:"POST",body:fd});
 const result=await res.json();

 allPredictions=result.rows;
 
 // Reset stats
 stats={total:0,present:0,absent:0,sumProb:0};
 clickBins=[0,0,0,0,0];

 const bounds=[];

 result.rows.forEach(d=>{
  const p=d.probability;

  stats.total++;
  stats.sumProb+=p;
  if(p>=threshold){
    stats.present++;
    bounds.push([d.decimalLatitude,d.decimalLongitude]);
  }else{
    stats.absent++;
  }

  // Update bins
  if(p<.2)clickBins[0]++;
  else if(p<.4)clickBins[1]++;
  else if(p<.6)clickBins[2]++;
  else if(p<.8)clickBins[3]++;
  else clickBins[4]++;
 });

 chart.data.datasets[0].data=clickBins;
 chart.update();
 updateStats();

 renderPredictions(allPredictions);

 if(bounds.length>0){
   map.fitBounds(bounds,{padding:[40,40]});
 }

 document.getElementById("stats").innerHTML=
  ` <b>${result.total_rows}</b> locations | ‚ö° ${result.inference_time_ms}ms`;
}

/* CLEAR */
function clearAll(){
 markers.clearLayers();
 if(heatLayer){
   map.removeLayer(heatLayer);
   heatLayer=null;
 }
 allPredictions=[];
 clickBins=[0,0,0,0,0];
 stats={total:0,present:0,absent:0,sumProb:0};
 
 chart.data.datasets[0].data=clickBins;
 chart.update();
 updateStats();
 
 document.getElementById("localFeatures").innerHTML='<li style="color:#9ca3af">Click v√†o b·∫£n ƒë·ªì ƒë·ªÉ xem</li>';
 document.getElementById("inferTime").innerText="-";
 document.getElementById("stats").innerText="";
}
</script>

</body>
</html>